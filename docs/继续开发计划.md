# fshows-iteration-cli 继续开发计划

## 项目概述

将现有的 `iteration-mcp` 工具重构为独立的 CLI npm 包 `fshows-iteration-cli`，提供更友好的命令行交互体验。

## 当前状况分析

### 原 MCP 项目优势

- ✅ 完整的业务逻辑实现（API管理、缓存、Git工具）
- ✅ 长城后端集成完善（API Key认证、项目组/用户管理、报告上传）
- ✅ TypeScript 代码架构清晰
- ✅ 5步交互式迭代创建流程设计成熟
- ✅ 错误处理和配置管理完善

### 需要改造的部分

- 🔄 入口文件：从 MCP 服务器 → CLI 应用
- 🔄 交互方式：从 MCP 工具调用 → 命令行交互
- 🔄 用户界面：添加友好的CLI界面
- 🔄 依赖管理：移除 MCP 相关依赖，添加 CLI 相关依赖

## 技术架构规划

### 目标项目结构

```
fshows-iteration-cli/
├── src/
│   ├── index.ts                  # CLI 主入口文件
│   ├── cli.ts                    # 命令行解析和路由
│   ├── commands/                 # 命令处理模块
│   │   ├── create.ts             # 创建迭代命令
│   │   ├── test.ts               # 测试连接命令
│   │   ├── users.ts              # 用户管理命令
│   │   ├── projects.ts           # 项目组管理命令
│   │   ├── config.ts             # 配置管理命令
│   │   └── init.ts               # 项目初始化命令
│   ├── core/                     # 核心业务逻辑（从原项目迁移）
│   │   ├── api.ts                # API管理器
│   │   ├── cache.ts              # 缓存管理
│   │   ├── git-utils.ts          # Git工具
│   │   ├── greatwall-client.ts   # 长城后端客户端
│   │   ├── greatwall-services.ts # 长城后端服务
│   │   └── types.ts              # 类型定义
│   ├── ui/                       # 用户界面组件
│   │   ├── prompts.ts            # 交互式提示组件
│   │   ├── spinner.ts            # 加载动画
│   │   ├── formatter.ts          # 输出格式化
│   │   └── themes.ts             # 主题和样式
│   └── utils/                    # 工具函数
│       ├── config.ts             # 配置管理（重构原config.ts）
│       ├── logger.ts             # 日志处理
│       ├── validation.ts         # 数据验证
│       └── helpers.ts            # 通用辅助函数
├── bin/
│   └── cli.js                    # npm bin 可执行文件
├── templates/                    # 配置模板文件
│   ├── .ficrc.template           # CLI配置模板
│   └── iteration-config.template # 迭代配置模板
├── docs/                         # 文档
│   ├── README.md                 # 项目说明
│   ├── API.md                    # API接口文档
│   └── CHANGELOG.md              # 更新日志
├── tests/                        # 测试文件
│   ├── unit/                     # 单元测试
│   ├── integration/              # 集成测试
│   └── fixtures/                 # 测试数据
├── package.json                  # 项目配置
├── tsconfig.json                 # TypeScript配置
├── .eslintrc.js                  # ESLint配置
└── .gitignore                    # Git忽略文件
```

## 核心模块迁移计划

### 第一优先级：核心业务逻辑迁移

需要从 `iteration-mcp/src/` 迁移以下文件：

1. **API管理模块**
   - `api.ts` → `src/core/api.ts`
   - 保留：长城后端集成、原系统API调用、两阶段提交流程
   - 修改：移除MCP相关依赖，保留核心业务逻辑

2. **缓存管理模块**
   - `cache.ts` → `src/core/cache.ts`
   - 保留：用户列表缓存、项目线历史、OSS上传等功能
   - 修改：适配CLI环境的配置路径

3. **Git工具模块**
   - `git-utils.ts` → `src/core/git-utils.ts`
   - 保留：智能工时计算、项目信息自动获取、配置文件读取
   - 完全保留，无需修改

4. **长城后端集成**
   - `greatwall-client.ts` → `src/core/greatwall-client.ts`
   - `greatwall-services.ts` → `src/core/greatwall-services.ts`
   - 完全保留，这是项目的核心价值

5. **类型定义**
   - `types.ts` → `src/core/types.ts`
   - 保留：所有业务类型定义
   - 新增：CLI相关类型定义

6. **配置管理**
   - `config.ts` → `src/utils/config.ts`
   - 重构：适配CLI环境的配置管理
   - 保留：长城后端配置、环境变量支持

### 第二优先级：CLI界面开发

1. **依赖选择**

```json
{
  "dependencies": {
    "commander": "^11.0.0",
    "inquirer": "^9.0.0", 
    "ora": "^7.0.0",
    "chalk": "^5.0.0",
    "boxen": "^7.0.0",
    "axios": "^1.6.0",
    "fs-extra": "^11.0.0"
  }
}
```

2. **命令设计**

```bash
# 主命令
fic --version
fic --help

# 子命令
fic create          # 创建迭代（交互式）
fic test            # 测试长城后端连接
fic users           # 管理用户列表
fic projects        # 管理项目组
fic config          # 配置管理
fic init            # 初始化项目配置

# 全局选项
--config <path>     # 指定配置文件路径
--workdir <path>    # 指定工作目录
--debug             # 启用调试模式
--no-cache          # 禁用缓存
```

3. **用户体验设计**

```
$ fic create

🚀 欢迎使用 FShows 迭代管理工具

┌─ 配置检查 ─────────────────────────────┐
│ ✅ 长城后端连接正常                      │
│ ✅ Git 仓库检测成功                      │
│ ✅ 工作目录: /path/to/project           │
└───────────────────────────────────────┘

? 选择项目组:
❯ 测试项目V2 (ID: 2)
  行业 (ID: 3)
  
? 迭代名称: v1.0.0 用户体验优化迭代
? 上线时间: (2024-12-25) 
? 创建人: 
❯ 张三 (ID: 1)
  李四 (ID: 2)

⠋ 正在创建迭代信息...
✅ 迭代创建成功！(ID: iter_12345)
✅ CR申请单创建成功！(ID: cr_12345)
```

## 实施计划

### 阶段1：项目初始化（预估1天）

- [ ] 创建基础项目结构
- [ ] 配置 package.json（bin, scripts, dependencies）
- [ ] 设置 TypeScript、ESLint 配置
- [ ] 创建基础的 CLI 入口文件

### 阶段2：核心模块迁移（预估2-3天）

- [ ] 迁移 `api.ts`，移除MCP依赖
- [ ] 迁移 `cache.ts`，适配CLI环境
- [ ] 迁移 `git-utils.ts`（无需修改）
- [ ] 迁移长城后端相关模块（无需修改）
- [ ] 迁移 `types.ts`，扩展CLI类型
- [ ] 重构 `config.ts`，适配CLI配置管理

### 阶段3：CLI界面开发（预估3-4天）

- [ ] 实现命令行参数解析（commander）
- [ ] 开发交互式创建迭代流程
- [ ] 实现各个子命令（test, users, projects等）
- [ ] 设计美观的输出界面（chalk, boxen, ora）
- [ ] 实现配置管理命令

### 阶段4：功能完善（预估2天）

- [ ] 错误处理和用户友好提示
- [ ] 配置文件模板和自动初始化
- [ ] 日志系统和调试模式
- [ ] 向后兼容性处理

### 阶段5：测试和文档（预估2天）

- [ ] 单元测试编写
- [ ] 集成测试编写
- [ ] 文档编写（README, API文档）
- [ ] 使用示例和最佳实践

### 阶段6：发布准备（预估1天）

- [ ] npm 包配置和发布
- [ ] CI/CD 流程设置
- [ ] 版本管理和更新日志

## 关键技术决策

### 1. 保持业务逻辑不变

- 完全保留原项目的5步创建流程
- 保持长城后端API调用格式
- 保留智能Git信息获取和工时计算

### 2. 配置管理策略

```javascript
// 配置文件优先级
1. 命令行参数 --config <path>
2. 项目配置 ./.ficrc 
3. 全局配置 ~/.fic/config.json
4. 环境变量
5. 默认配置
```

### 3. 数据存储

- 缓存：`~/.fic/cache/`
- 配置：`~/.fic/config.json`
- 日志：`~/.fic/logs/`

### 4. 兼容性考虑

- 支持原项目的配置文件格式
- 提供配置迁移工具
- 保持API调用接口一致

## 潜在风险与对策

### 1. 迁移风险

- **风险**：业务逻辑迁移出错
- **对策**：保持模块化，逐个迁移验证

### 2. 用户体验风险

- **风险**：CLI界面不够友好
- **对策**：参考优秀CLI工具设计，重视错误提示

### 3. 兼容性风险

- **风险**：与原有配置不兼容
- **对策**：提供配置迁移工具和向下兼容

## 成功指标

- [ ] 保持原有功能100%可用
- [ ] CLI界面友好，错误提示清晰
- [ ] 安装和使用更简单（npm install -g）
- [ ] 性能不低于原MCP工具
- [ ] 文档齐全，易于维护

## 后续扩展计划

### v1.1: 增强功能

- 批量操作支持
- 配置模板管理
- 多项目管理

### v1.2: 集成优化

- IDE插件支持
- CI/CD集成
- Webhook支持

### v2.0: 平台扩展

- Web界面
- 团队协作功能
- 统计分析

---

*本计划基于对原 `iteration-mcp` 项目的深入分析制定，旨在保持核心价值的同时大幅提升用户体验。*

**预估总工期：10-12天**

**建议开发人员：1-2人**

**技术要求：熟悉 TypeScript、Node.js、CLI开发**
