# @asthestarslept/iteration-cli 使用指南

一个迭代管理CLI工具，适配长城迭代管理，支持创建迭代、管理CR申请单。

## 📦 安装

### 全局安装（推荐）

```bash
npm install -g @asthestarslept/iteration-cli
```

### 验证安装

```bash
fiter --version
fiter --help
```

## 🚀 快速开始

### 1. 查看配置状态

工具会自动使用环境变量配置，首次使用可以查看配置状态：

```bash
fiter config show
```

### 2. 创建迭代

```bash
fiter create
```

该命令将引导你完成：

- ✅ 选择项目组和创建人
- ✅ 设置迭代名称和上线时间
- ✅ 创建多个CR申请单
- ✅ 智能分析Git差异，自动识别组件和功能模块

## 📋 详细功能

### 迭代创建流程

#### 第一步：基础信息收集

- 选择所属项目组
- 输入迭代名称（默认：`v1.0.0 项目名 迭代`）
- 设置上线时间（默认：当前日期+14天）
- 选择创建人
- 添加备注信息（可选）

#### 第二步：CR申请单管理

支持为一个迭代创建多个CR申请单，每个申请单可以对应不同的项目：

1. **项目信息来源**：
   - 📁 从其他项目目录获取Git信息
   - ✏️ 手动输入项目信息
   - 🔄 继续使用当前目录

2. **项目详细信息**：
   - Git项目名称和仓库地址
   - 开发分支名
   - 产品文档链接
   - 预估工时
   - 参与人员和审核人员

#### 第三步：智能模块分析

基于Git差异的智能分析功能：

**组件模块检测**：

- 自动扫描 `/components/`等目录
- 识别 `.vue` 组件文件
- 支持 PascalCase 命名的组件文件
- 显示文件状态：🟢新增、🟡修改、🔴删除

**功能模块检测**：

- 自动分类识别：
  - 📄 **页面模块**：`/pages/`、`/views/`
  - 🔌 **API服务**：`/api/`、`/services/`
  - 🛠️ **工具函数**：`/utils/`、`/helpers/`
  - 📊 **状态管理**：`/store/`、`/stores/`
  - ⚙️ **功能模块**：`/features/`、`/modules/`

## 🔧 命令详解

### `fiter create`

创建迭代和CR申请单的主命令。

**可选参数：**

```bash
fiter create --dir /path/to/project
```

**交互流程：**

1. 获取当前目录Git信息
2. 连接API并获取基础数据（用户列表、项目组）
3. 收集迭代基础信息
4. 创建迭代
5. 收集CR申请单信息（支持多个）
6. 批量创建CR申请单

### `fiter config`

配置管理命令。

**子命令：**

```bash
fiter config show   # 显示当前配置
fiter config check  # 检查配置完整性
```

**说明：**
工具通过环境变量自动管理配置，无需手动设置

### `fiter debug`

调试和诊断工具。

**子命令：**

```bash
fiter debug git      # 检查Git信息获取
fiter debug api      # 测试长城后端API连接
fiter debug env      # 显示环境信息
fiter debug cache    # 显示用户选择缓存状态
fiter debug user     # 显示和管理保存的创建人信息
fiter debug reset    # 清空所有缓存和配置，重新初始化
```

**功能包括：**

- 🔍 检查配置有效性
- 🌐 测试API连接
- 📁 分析当前目录Git信息
- 🔄 显示Git差异分析结果
- 📊 生成详细的调试报告
- 💾 管理用户选择缓存和创建人信息
- 🔄 重置所有缓存和配置

## 🚀 新功能特性

### 1. 智能用户选择缓存

工具会自动记录你的人员选择习惯，优化后续使用体验：

**✨ 智能特性：**

- 🎯 **最近使用优先** - 常用人员排在选择列表前面，标记⭐
- 📝 **自动预选** - 上次选择的参与人员和审核人员会自动预选中
- 💾 **历史记忆** - 记录文件类型的审查人员偏好

**📊 缓存管理：**

```bash
# 查看缓存状态
fiter debug cache

# 查看保存的创建人
fiter debug user

# 清除保存的创建人（重新选择）
fiter debug user --clear

# 完全重置所有缓存
fiter debug reset
```

### 2. 自动创建人检测

**首次使用时：**

- 选择创建人后自动保存到本机配置
- 显示：`💾 已保存创建人信息: 张三`

**后续使用时：**

- 自动使用保存的创建人，跳过选择步骤
- 显示：`✅ 创建人: 张三 (自动使用保存的用户)`

### 3. 批量审查人员分配

检测到多个文件需要分配审查人员时，提供智能分配选项：

**🚀 分配模式：**

- **统一分配** - 所有文件分配给同一人（最快）
- **按文件类型分配** - 根据 .vue、.ts 等文件类型智能分配（推荐）
- **按目录结构分配** - 根据 components、utils 等目录分配
- **逐个文件选择** - 传统的逐个选择模式

**💡 智能推荐：**

- 基于历史使用记录推荐最合适的审查人员
- 支持批量预览和个别调整

### 4. 完全重置功能

当需要重新开始或遇到问题时：

```bash
# 交互式重置（安全，需要确认）
fiter debug reset

# 直接重置（跳过确认）
fiter debug reset --confirm
```

**🧹 清理内容：**

- 用户选择缓存（参与人员、审核人员历史）
- 文件类型偏好记录
- 保存的创建人信息
- 所有配置文件

## 💡 使用技巧

### 1. 多项目管理

当需要为同一迭代创建多个不同项目的CR申请单时：

```bash
# 在主项目目录执行
cd /path/to/main-project
fiter create

# 在交互过程中：
# 1. 第一个CR申请单选择"继续使用当前目录"
# 2. 第二个CR申请单选择"从其他项目目录获取Git信息"
# 3. 输入其他项目路径：/path/to/another-project
```

### 2. Git差异分析优化

为了获得最佳的差异分析结果：

```bash
# 确保本地分支与远程同步
git fetch origin

# 确保有明确的基础分支
git branch -r  # 查看远程分支
```

### 3. 批量操作

工具支持在一次执行中创建多个CR申请单，大大提高效率：

- ✅ 一次性收集所有信息
- ✅ 批量创建，显示进度
- ✅ 失败重试机制
- ✅ 详细的结果统计

## ⚠️ 注意事项

### 常见问题

#### 1. Git差异分析失败

```bash
# 检查是否为Git仓库
git status

# 检查远程分支
git branch -r

# 同步远程分支
git fetch origin
```

#### 2. API连接失败

```bash
# 检查配置
fiter config show

# 测试连接
fiter debug

# 检查配置完整性
fiter config check
```

#### 3. CR申请单创建失败

- 检查网络连接
- 确认API密钥有效
- 验证用户权限
- 查看错误日志
